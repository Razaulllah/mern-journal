import * as core from '@contentlayer/core';
import { processArgs, SourceProvideSchemaError } from '@contentlayer/core';
import { unknownToAbsolutePosixFilePath, unknownToRelativePosixFilePath } from '@contentlayer/utils';
import { pipe, S, T } from '@contentlayer/utils/effect';
import { fetchData } from './fetchData/index.js';
import { makeCoreSchema } from './schema/provideSchema.js';
export * from './types.js';
export * from './schema/defs/index.js';
export const makeSource = (args) => async (sourceKey) => {
    const { options, extensions, restArgs: { documentTypes, contentDirPath: contentDirPath_, contentDirInclude: contentDirInclude_, contentDirExclude: contentDirExclude_, onUnknownDocuments = 'skip-warn', onMissingOrIncompatibleData = 'skip-warn', onExtraFieldData = 'warn', }, } = await processArgs(args, sourceKey);
    const flags = { onUnknownDocuments, onExtraFieldData, onMissingOrIncompatibleData };
    const documentTypeDefs = (Array.isArray(documentTypes) ? documentTypes : Object.values(documentTypes)).map((_) => _.def());
    return {
        type: 'local',
        extensions: extensions ?? {},
        options,
        provideSchema: (esbuildHash) => pipe(makeCoreSchema({ documentTypeDefs, options, esbuildHash }), T.mapError((error) => new SourceProvideSchemaError({ error }))),
        fetchData: ({ schemaDef, verbose, skipCachePersistence }) => pipe(S.fromEffect(core.getCwd), S.chain((cwd) => {
            const contentDirPath = unknownToAbsolutePosixFilePath(contentDirPath_, cwd);
            const contentDirExclude = (contentDirExclude_ ?? contentDirExcludeDefault).map((_) => unknownToRelativePosixFilePath(_, contentDirPath));
            const contentDirInclude = (contentDirInclude_ ?? []).map((_) => unknownToRelativePosixFilePath(_, contentDirPath));
            return fetchData({
                coreSchemaDef: schemaDef,
                documentTypeDefs,
                flags,
                options,
                contentDirPath,
                contentDirExclude,
                contentDirInclude,
                verbose,
                skipCachePersistence,
            });
        })),
    };
};
export const contentDirExcludeDefault = ['node_modules', '.git', '.yarn', '.cache', '.next', '.contentlayer'];
//# sourceMappingURL=index.js.map